name: Docker Image CI

on:
  push:
    branches:
      - 'work'
    tags:
      - 'v*'    # åªæœ‰åˆ›å»º v tag çš„æ—¶å€™æ‰æ„å»º

jobs:
  CompileBook:
  # åŸºç¡€è¿è¡Œç¯å¢ƒ
    runs-on: ubuntu-latest
    steps:
    # æ‹‰å–ä»£ç 
      - uses: actions/checkout@v3
        with:
          submodules: true  # Fetch Hugo themes (true OR recursive)
          fetch-depth: 0    # Fetch all history for .GitInfo and .Lastmod
          
      - run: echo "ğŸ’¡ The ${{ github.repository }} repository has been cloned to the runner."
      - run: echo "ğŸ–¥ï¸ The workflow is now ready to test your code on the runner."
      - run: ls -lah
      # å®‰è£…ã€è¿˜åŸ ä¾èµ–
      - run: yarn -i

      # ä½¿ç”¨ Hugo ç¼–è¯‘å‘å¸ƒç½‘ç«™
      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v2
        with:
          hugo-version: 0.101.0
          extended: true
          
      - name: Build
        run: hugo --minify

      - name: Deploy
        uses: peaceiris/actions-gh-pages@v3
        if: ${{ github.ref == 'refs/heads/main' }}
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          
      # æŸ¥çœ‹ç›®å½•æ–‡ä»¶
      - name: SeeDir
        run: ls -lah public
    
     # ç™»å½• Docker ä»“åº“
      - name: Docker Login
        uses: docker/login-action@v2.0.0
        with:
          registry: registry.cn-hangzhou.aliyuncs.com
          username: ${{ secrets.DOCKER_NAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
          logout: true
        
      # æ„å»º Docker é•œåƒ
      - name: Build and push Docker images
        uses: docker/build-push-action@v3.1.0
        with:
          context: .
          file: ./Dockerfile
          push: false
          tags: registry.cn-hangzhou.aliyuncs.com/whuanle/daprbook:latest
          
      - name: Push Docker
        run: docker push registry.cn-hangzhou.aliyuncs.com/whuanle/daprbook:latest
